#!/bin/bash

set -e

APP_DIR=$1
DEPS_DIR=$3
IDX=$4

log_prefix='-----> [env-map-buildpack]'

CONFIG=${ENV_MAP_BP_CONFIG:-"env-map.yml"}
echo "$log_prefix Creating profile.d file using $CONFIG"

if [[ $CONFIG =~ .json ]]; then
  JSON_CONFIG="$(< "$APP_DIR/$CONFIG")"
else
  echo "$log_prefix Downloading yq"
  curl -L https://github.com/mikefarah/yq/releases/download/2.4.1/yq_linux_amd64 -o yq
  chmod +x yq
  JSON_CONFIG="$(./yq r "$APP_DIR/$CONFIG" -j)"
fi

mkdir -p "$DEPS_DIR/$IDX/profile.d"
for var in $(echo "$JSON_CONFIG" | jq -r '.env_vars | keys[]'); do
  selector="$(echo "$JSON_CONFIG" | jq -r ".env_vars.$var")"
  echo "export $var=\"\$(echo \$VCAP_SERVICES | jq -r '$selector')\"" >> "$DEPS_DIR/$IDX/profile.d/$IDX-mapped-env-vars.sh"
done

echo "$log_prefix Done."
exit 0

